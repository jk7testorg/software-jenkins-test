pipeline {
    agent any

    environment {
        REPO = "https://github.com/jk7testorg/${{values.app_name}}"
        BRANCH = 'main'
        KUBECONFIG = credentials('kubeconfig-secret') // Jenkins secret for cluster access
        APP_YAML_URL = "https://raw.githubusercontent.com/jk7testorg/${{values.app_name}}/main/argocd/application.yaml"
    }

    stages {
        stage('Install Dependencies') {
            steps {
                echo "Setting up Python environment..."
                sh 'python3 -m venv venv'
                sh '. venv/bin/activate && pip install -r requirements.txt'
            }
        }

        stage('Run Tests') {
            steps {
                echo "Running Python tests..."
                sh '. venv/bin/activate && pytest || true'
            }
        }

        stage('Build') {
            steps {
                echo "Building application..."
                sh 'echo "Build placeholder..."'
            }
        }

        stage('Archive Artifacts') {
            steps {
                archiveArtifacts artifacts: '**/*.log, **/*.txt', allowEmptyArchive: true
            }
        }

        stage('Deploy ArgoCD Application') {
            steps {
                echo "Applying ArgoCD Application YAML to cluster..."
                sh '''
                kubectl apply -f $APP_YAML_URL
                '''
            }
        }

        stage('Verify ArgoCD Application') {
            steps {
                echo "Checking ArgoCD applications in cluster..."
                sh '''
                kubectl get applications -n argocd
                '''
            }
        }
    }

    post {
        always {
            echo 'Pipeline finished.'
        }
        success {
            echo 'Build and deployment succeeded!'
        }
        failure {
            echo 'Build or deployment failed!'
        }
    }
}
